name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Setup SSH Key and Deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: "wnnroot"
          SSH_HOST: "194.127.192.224"
          SSH_PORT: "22"
        run: |
          TEMP_KEY_FILE=$(mktemp)
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > "$TEMP_KEY_FILE"
          chmod 600 "$TEMP_KEY_FILE"

          if [[ ! -f "$TEMP_KEY_FILE" ]]; then
              echo "Error: Gagal membuat file kunci privat sementara."
              exit 1
          fi

          # Validasi format kunci privat
          openssl rsa -in "$TEMP_KEY_FILE" -check -noout
          if [[ $? -ne 0 ]]; then
              echo "Error: Format kunci SSH tidak valid."
              rm -f "$TEMP_KEY_FILE"
              exit 1
          fi

          ssh -i "$TEMP_KEY_FILE" -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'EOF'
            echo "Koneksi SSH berhasil!"
            # Tambahkan perintah deployment di sini
          EOF

          if [[ $? -ne 0 ]]; then
              echo "Error: Gagal terhubung ke server melalui SSH."
              rm -f "$TEMP_KEY_FILE"
              exit 255
          fi

          rm -f "$TEMP_KEY_FILE"
          echo "Deployment berhasil diselesaikan."
